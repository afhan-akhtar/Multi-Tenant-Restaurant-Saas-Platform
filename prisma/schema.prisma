// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ================================
// Super Admin (Platform Owner)
// ================================

model SuperAdmin {
  id           Int           @id @default(autoincrement())
  name         String
  email        String        @unique
  passwordHash String
  twoFaEnabled Boolean       @default(false)
  lastLogin    DateTime?
  status       String        @default("active")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  restaurants  Restaurant[]
}

// ================================
// Restaurants (Tenants)
// ================================

model Restaurant {
  id            Int            @id @default(autoincrement())
  ownerId       Int
  owner         SuperAdmin     @relation(fields: [ownerId], references: [id])
  name          String
  subdomain     String         @unique
  status        String         @default("active")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  branches      Branch[]
  staff         Staff[]
  categories    Category[]
  extraCats     ExtraCategory[]
  collections   Collection[]
  customers     Customer[]
  subs          RestaurantSubscription[]
  invoices      Invoice[]
  segments      Segment[]
  discounts     DiscountCode[]
}

model Branch {
  id           Int           @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id])
  name         String
  address      String
  city         String
  country      String
  phone        String
  status       String        @default("open")

  staff        Staff[]
  tables       Table[]
  orders       Order[]
  kdsScreens   KDSScreen[]
  errorLogs    ErrorLog[]
}

// ================================
// Staff & RBAC
// ================================

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique // Admin, Waiter, Chef
  description     String?
  staff           Staff[]
  rolePermissions RolePermission[]
}

model Staff {
  id           Int           @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id])
  branchId     Int?
  branch       Branch?       @relation(fields: [branchId], references: [id])
  roleId       Int
  role         Role          @relation(fields: [roleId], references: [id])
  name         String
  email        String        @unique
  passwordHash String
  twoFaEnabled Boolean       @default(false)
  lastLogin    DateTime?
  status       String        @default("active")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  sessions     Session[]
  activities   ActivityLog[]
  loginHistory LoginHistory[]
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])
}

// ================================
// Menu & Extras
// ================================

model Category {
  id           Int        @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  name         String
  parentId     Int?
  parent       Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children     Category[] @relation("SubCategories")
  products     Product[]
}

model Product {
  id             Int              @id @default(autoincrement())
  categoryId     Int
  category       Category         @relation(fields: [categoryId], references: [id])
  name           String
  description    String?
  basePrice      Decimal          @db.Decimal(12, 2)
  plu            String?
  barcode        String?
  availableTimes Json?
  stockQty       Int              @default(0)
  taxRate        Decimal          @db.Decimal(5, 2)

  variants       ProductVariant[]
  notes          ProductNote[]
  labels         ProductLabel[]
  collections    ProductCollection[]
  orderItems     OrderItem[]
}

model ProductVariant {
  id        Int         @id @default(autoincrement())
  productId Int
  product   Product     @relation(fields: [productId], references: [id])
  name      String
  price     Decimal     @db.Decimal(12, 2)
  orderItems OrderItem[]
}

model ExtraCategory {
  id           Int         @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  name         String
  items        ExtraItem[]
}

model ExtraItem {
  id         Int           @id @default(autoincrement())
  categoryId Int
  category   ExtraCategory @relation(fields: [categoryId], references: [id])
  name       String
  price      Decimal       @db.Decimal(12, 2)
}

model Collection {
  id           Int                 @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant          @relation(fields: [restaurantId], references: [id])
  name         String
  products     ProductCollection[]
}

model ProductCollection {
  productId    Int
  collectionId Int
  product      Product    @relation(fields: [productId], references: [id])
  collection   Collection @relation(fields: [collectionId], references: [id])

  @@id([productId, collectionId])
}

model ProductNote {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  name      String
}

model ProductLabel {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  name      String
}

// ================================
// POS: Tables & Sessions
// ================================

model Table {
  id       Int       @id @default(autoincrement())
  branchId Int
  branch   Branch    @relation(fields: [branchId], references: [id])
  name     String
  shape    String?
  seats    Int
  qrCode   String?
  status   String    @default("available")
  floor    String?
  sessions Session[]
}

model Session {
  id       Int       @id @default(autoincrement())
  tableId  Int
  table    Table     @relation(fields: [tableId], references: [id])
  openedAt DateTime  @default(now())
  closedAt DateTime?
  waiterId Int
  waiter   Staff     @relation(fields: [waiterId], references: [id])
  status   String    @default("active")
  orders   Order[]
}

// ================================
// Customers & Loyalty
// ================================

model Customer {
  id           Int           @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id])
  name         String?       @default("Guest")
  phone        String?
  email        String?
  address      String?
  createdAt    DateTime      @default(now())
  loyalty      LoyaltyPoint?
  orders       Order[]
}

model LoyaltyPoint {
  id         Int      @id @default(autoincrement())
  customerId Int      @unique
  customer   Customer @relation(fields: [customerId], references: [id])
  points     Int      @default(0)
  updatedAt  DateTime @updatedAt
}

// ================================
// Orders & Payments
// ================================

model Order {
  id          Int         @id @default(autoincrement())
  sessionId   Int?
  session     Session?    @relation(fields: [sessionId], references: [id])
  branchId    Int
  branch      Branch      @relation(fields: [branchId], references: [id])
  customerId  Int?
  customer    Customer?   @relation(fields: [customerId], references: [id])
  orderType   String      // dine-in, takeaway, delivery
  status      String      @default("pending")
  totalAmount Decimal     @db.Decimal(12, 2)
  taxAmount   Decimal     @db.Decimal(12, 2)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items       OrderItem[]
  payments    Payment[]
  feedback    Feedback[]
}

model OrderItem {
  id          Int             @id @default(autoincrement())
  orderId     Int
  order       Order           @relation(fields: [orderId], references: [id])
  productId   Int
  product     Product         @relation(fields: [productId], references: [id])
  variantId   Int?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  quantity    Int
  price       Decimal         @db.Decimal(12, 2)
  taxAmount   Decimal         @db.Decimal(12, 2)
  notes       String?
  status      String          @default("pending")
  kdsItems    KDSOrder[]
}

model Payment {
  id               Int      @id @default(autoincrement())
  orderId          Int
  order            Order    @relation(fields: [orderId], references: [id])
  paymentMethod    String   // cash, card, split
  amount           Decimal  @db.Decimal(12, 2)
  tip              Decimal  @default(0) @db.Decimal(12, 2)
  cardType         String?
  cardLast4        String?
  splitCashAmount  Decimal? @db.Decimal(12, 2)
  splitCardAmount  Decimal? @db.Decimal(12, 2)
  createdAt        DateTime @default(now())
}

// ================================
// Kitchen Display System (KDS)
// ================================

model KDSScreen {
  id       Int        @id @default(autoincrement())
  branchId Int
  branch   Branch     @relation(fields: [branchId], references: [id])
  name     String
  type     String
  kdsOrders KDSOrder[]
}

model KDSOrder {
  id          Int       @id @default(autoincrement())
  orderItemId Int
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  screenId    Int
  screen      KDSScreen @relation(fields: [screenId], references: [id])
  status      String    @default("queued")
  updatedAt   DateTime  @updatedAt
}

// ================================
// Subscriptions & Billing
// ================================

model SubscriptionPlan {
  id           Int                      @id @default(autoincrement())
  name         String
  price        Decimal                  @db.Decimal(12, 2)
  durationDays Int
  features     Json?
  subs         RestaurantSubscription[]
}

model RestaurantSubscription {
  id           Int              @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id])
  planId       Int
  plan         SubscriptionPlan @relation(fields: [planId], references: [id])
  startDate    DateTime         @default(now())
  endDate      DateTime
  status       String           @default("active")
}

model Invoice {
  id           Int              @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id])
  amount       Decimal          @db.Decimal(12, 2)
  dueDate      DateTime
  status       String           @default("unpaid")
  pdfUrl       String?
  payments     PaymentHistory[]
}

model PaymentHistory {
  id            Int      @id @default(autoincrement())
  invoiceId     Int
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])
  paymentMethod String
  amount        Decimal  @db.Decimal(12, 2)
  paidAt        DateTime @default(now())
}

// ================================
// Marketing & CRM
// ================================

model Segment {
  id           Int        @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  name         String
  criteria     Json
}

model DiscountCode {
  id           Int        @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  code         String     @unique
  type         String     // percentage, fixed
  value        Decimal    @db.Decimal(12, 2)
  validFrom    DateTime
  validTo      DateTime
}

model Feedback {
  id        Int      @id @default(autoincrement())
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id])
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
}

// ================================
// Audit & Logs
// ================================

model ActivityLog {
  id         Int      @id @default(autoincrement())
  staffId    Int
  staff      Staff    @relation(fields: [staffId], references: [id])
  action     String
  entityType String
  entityId   Int
  timestamp  DateTime @default(now())
  details    Json?
}

model ErrorLog {
  id           Int      @id @default(autoincrement())
  branchId     Int?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  errorMessage String
  stackTrace   String?
  createdAt    DateTime @default(now())
}

model LoginHistory {
  id        Int      @id @default(autoincrement())
  staffId   Int
  staff     Staff    @relation(fields: [staffId], references: [id])
  ipAddress String?
  userAgent String?
  success   Boolean
  timestamp DateTime @default(now())
}