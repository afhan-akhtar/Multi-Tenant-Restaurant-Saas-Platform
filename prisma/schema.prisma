// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ================================
// Super Admin (Platform Owner)
// ================================
model SuperAdmin {
  id              Int           @id @default(autoincrement())
  name            String
  email           String        @unique
  passwordHash    String        @map("password_hash")
  twoFactorEnabled Boolean      @default(false) @map("2fa_enabled")
  lastLogin       DateTime?     @map("last_login")
  status          String
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  restaurants     Restaurant[]

  @@map("super_admin")
}

// ================================
// Restaurants (Tenants)
// ================================
model Restaurant {
  id              Int           @id @default(autoincrement())
  ownerId         Int           @map("owner_id")
  name            String
  subdomain       String        @unique
  status          String
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  owner           SuperAdmin    @relation(fields: [ownerId], references: [id])
  branches        Branch[]
  staff           Staff[]
  categories      Category[]
  extraCategories ExtraCategory[]
  collections     Collection[]
  customers       Customer[]
  segments        Segment[]
  discountCodes   DiscountCode[]
  subscriptions   RestaurantSubscription[]
  invoices        Invoice[]

  @@map("restaurants")
}

model Branch {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  name          String
  address       String
  city          String
  country       String
  phone         String
  status        String

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  staff         Staff[]
  tables        TableEntity[]
  orders        Order[]
  kdsScreens    KdsScreen[]
  errorLogs     ErrorLog[]

  @@map("branches")
}

// ================================
// Staff (Restaurant Employees)
// ================================
model Role {
  id            Int           @id @default(autoincrement())
  name          String        @unique // Admin, Waiter, Chef
  description   String?
  
  staff         Staff[]
  permissions   RolePermission[]

  @@map("roles")
}

model Staff {
  id              Int           @id @default(autoincrement())
  restaurantId    Int           @map("restaurant_id")
  branchId        Int?          @map("branch_id")
  roleId          Int           @map("role_id")
  name            String
  email           String        @unique
  passwordHash    String        @map("password_hash")
  twoFactorEnabled Boolean      @default(false) @map("2fa_enabled")
  lastLogin       DateTime?     @map("last_login")
  status          String
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  restaurant      Restaurant    @relation(fields: [restaurantId], references: [id])
  branch          Branch?       @relation(fields: [branchId], references: [id])
  role            Role          @relation(fields: [roleId], references: [id])
  sessions        Session[]
  activityLogs    ActivityLog[]
  loginHistories  LoginHistory[]

  @@map("staff")
}

model Permission {
  id            Int           @id @default(autoincrement())
  name          String        @unique
  description   String?
  
  roles         RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id            Int           @id @default(autoincrement())
  roleId        Int           @map("role_id")
  permissionId  Int           @map("permission_id")

  role          Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission    Permission    @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@map("role_permissions")
}

// ================================
// Menu & Extras
// ================================
model Category {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  name          String
  parentId      Int?          @map("parent_id")

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  parent        Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[]    @relation("CategoryHierarchy")
  products      Product[]

  @@map("categories")
}

model Product {
  id              Int           @id @default(autoincrement())
  categoryId      Int           @map("category_id")
  name            String
  description     String?
  basePrice       Decimal       @db.Decimal(10, 2) @map("base_price")
  plu             String?       @map("PLU")
  barcode         String?
  availableTimes  Json?         @map("available_times")
  stockQty        Int           @default(0) @map("stock_qty")
  taxRate         Decimal       @db.Decimal(5, 2) @map("tax_rate")

  category        Category      @relation(fields: [categoryId], references: [id])
  variants        ProductVariant[]
  orderItems      OrderItem[]
  collections     ProductCollection[]
  productNotes    ProductNote[]
  productLabels   ProductLabel[]

  @@map("products")
}

model ProductVariant {
  id          Int           @id @default(autoincrement())
  productId   Int           @map("product_id")
  name        String
  price       Decimal       @db.Decimal(10, 2)

  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]

  @@map("product_variants")
}

model ExtraCategory {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  name          String

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  extraItems    ExtraItem[]

  @@map("extra_categories")
}

model ExtraItem {
  id            Int           @id @default(autoincrement())
  categoryId    Int           @map("category_id")
  name          String
  price         Decimal       @db.Decimal(10, 2)

  category      ExtraCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("extra_items")
}

model Collection {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  name          String

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  products      ProductCollection[]

  @@map("collections")
}

model ProductCollection {
  productId     Int           @map("product_id")
  collectionId  Int           @map("collection_id")

  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection    Collection    @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([productId, collectionId])
  @@map("product_collections")
}

model ProductNote {
  id          Int           @id @default(autoincrement())
  productId   Int           @map("product_id")
  name        String

  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_notes")
}

model ProductLabel {
  id          Int           @id @default(autoincrement())
  productId   Int           @map("product_id")
  name        String

  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_labels")
}

// ================================
// Tables & Sessions (POS)
// ================================
model TableEntity {
  id          Int           @id @default(autoincrement())
  branchId    Int           @map("branch_id")
  name        String
  shape       String?
  seats       Int?
  qrCode      String?       @map("QR_code")
  status      String
  floor       String?

  branch      Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  sessions    Session[]

  @@map("tables")
}

model Session {
  id          Int           @id @default(autoincrement())
  tableId     Int           @map("table_id")
  openedAt    DateTime      @default(now()) @map("opened_at")
  closedAt    DateTime?     @map("closed_at")
  waiterId    Int           @map("waiter_id")
  status      String

  table       TableEntity   @relation(fields: [tableId], references: [id])
  waiter      Staff         @relation(fields: [waiterId], references: [id])
  orders      Order[]

  @@map("sessions")
}

// ================================
// Customers & Loyalty Points
// ================================
model Customer {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  name          String?
  phone         String?
  email         String?
  address       String?
  createdAt     DateTime      @default(now()) @map("created_at")

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  loyaltyPoints LoyaltyPoint?
  orders        Order[]

  @@map("customers")
}

model LoyaltyPoint {
  id          Int           @id @default(autoincrement())
  customerId  Int           @unique @map("customer_id")
  points      Int           @default(0)
  updatedAt   DateTime      @updatedAt @map("updated_at")

  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

// ================================
// Orders (POS)
// ================================
model Order {
  id            Int           @id @default(autoincrement())
  sessionId     Int?          @map("session_id")
  branchId      Int           @map("branch_id")
  customerId    Int?          @map("customer_id")
  orderType     String        @map("order_type")
  status        String
  totalAmount   Decimal       @db.Decimal(10, 2) @map("total_amount")
  taxAmount     Decimal       @db.Decimal(10, 2) @map("tax_amount")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  session       Session?      @relation(fields: [sessionId], references: [id])
  branch        Branch        @relation(fields: [branchId], references: [id])
  customer      Customer?     @relation(fields: [customerId], references: [id])
  items         OrderItem[]
  payments      Payment[]
  feedbacks     Feedback[]

  @@map("orders")
}

model OrderItem {
  id          Int           @id @default(autoincrement())
  orderId     Int           @map("order_id")
  productId   Int           @map("product_id")
  variantId   Int?          @map("variant_id")
  quantity    Int
  price       Decimal       @db.Decimal(10, 2)
  taxAmount   Decimal       @db.Decimal(10, 2) @map("tax_amount")
  notes       String?
  status      String

  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product       @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  kdsOrders   KdsOrder[]

  @@map("order_items")
}

// ================================
// Payments (POS)
// ================================
model Payment {
  id                Int           @id @default(autoincrement())
  orderId           Int           @map("order_id")
  paymentMethod     String        @map("payment_method")
  amount            Decimal       @db.Decimal(10, 2)
  tip               Decimal?      @db.Decimal(10, 2) @default(0)
  cardType          String?       @map("card_type")
  cardLast4         String?       @map("card_last4")
  splitCashAmount   Decimal?      @db.Decimal(10, 2) @map("split_cash_amount")
  splitCardAmount   Decimal?      @db.Decimal(10, 2) @map("split_card_amount")
  createdAt         DateTime      @default(now()) @map("created_at")

  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ================================
// Kitchen Display System (KDS)
// ================================
model KdsScreen {
  id          Int           @id @default(autoincrement())
  branchId    Int           @map("branch_id")
  name        String
  type        String

  branch      Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  kdsOrders   KdsOrder[]

  @@map("kds_screens")
}

model KdsOrder {
  id            Int           @id @default(autoincrement())
  orderItemId   Int           @map("order_item_id")
  screenId      Int           @map("screen_id")
  status        String
  updatedAt     DateTime      @updatedAt @map("updated_at")

  orderItem     OrderItem     @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  screen        KdsScreen     @relation(fields: [screenId], references: [id])

  @@map("kds_orders")
}

// ================================
// Subscriptions & Billing
// ================================
model SubscriptionPlan {
  id            Int           @id @default(autoincrement())
  name          String
  price         Decimal       @db.Decimal(10, 2)
  durationDays  Int           @map("duration_days")
  features      Json?

  subscriptions RestaurantSubscription[]

  @@map("subscription_plans")
}

model RestaurantSubscription {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  planId        Int           @map("plan_id")
  startDate     DateTime      @map("start_date")
  endDate       DateTime      @map("end_date")
  status        String

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  plan          SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("restaurant_subscriptions")
}

model Invoice {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  amount        Decimal       @db.Decimal(10, 2)
  dueDate       DateTime      @map("due_date")
  status        String
  pdfUrl        String?       @map("pdf_url")

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  paymentHistory PaymentHistory[]

  @@map("invoices")
}

model PaymentHistory {
  id            Int           @id @default(autoincrement())
  invoiceId     Int           @map("invoice_id")
  paymentMethod String        @map("payment_method")
  amount        Decimal       @db.Decimal(10, 2)
  paidAt        DateTime      @default(now()) @map("paid_at")

  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payment_history")
}

// ================================
// Marketing & CRM
// ================================
model Segment {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  name          String
  criteria      Json?

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])

  @@map("segments")
}

model DiscountCode {
  id            Int           @id @default(autoincrement())
  restaurantId  Int           @map("restaurant_id")
  code          String        @unique
  type          String
  value         Decimal       @db.Decimal(10, 2)
  validFrom     DateTime?     @map("valid_from")
  validTo       DateTime?     @map("valid_to")

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])

  @@map("discount_codes")
}

model Feedback {
  id          Int           @id @default(autoincrement())
  orderId     Int           @map("order_id")
  rating      Int
  comment     String?
  createdAt   DateTime      @default(now()) @map("created_at")

  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("feedback")
}

// ================================
// Audit & Logs
// ================================
model ActivityLog {
  id          Int           @id @default(autoincrement())
  staffId     Int           @map("staff_id")
  action      String
  entityType  String?       @map("entity_type")
  entityId    Int?          @map("entity_id")
  timestamp   DateTime      @default(now())
  details     Json?

  staff       Staff         @relation(fields: [staffId], references: [id])

  @@map("activity_log")
}

model ErrorLog {
  id            Int           @id @default(autoincrement())
  branchId      Int?          @map("branch_id")
  errorMessage  String?       @map("error_message")
  stackTrace    String?       @map("stack_trace")
  createdAt     DateTime      @default(now()) @map("created_at")

  branch        Branch?       @relation(fields: [branchId], references: [id])

  @@map("error_log")
}

model LoginHistory {
  id          Int           @id @default(autoincrement())
  staffId     Int           @map("staff_id")
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  success     Boolean
  timestamp   DateTime      @default(now())

  staff       Staff         @relation(fields: [staffId], references: [id])

  @@map("login_history")
}